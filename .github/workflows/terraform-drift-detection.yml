name: Terraform Drift Detection with Email Alert

on:
  schedule:
    - cron: "0 14 * * *" 
  workflow_dispatch:      # Manual trigger button

permissions:
  id-token: write
  contents: read

jobs:
  drift-detection:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        env:
          - name: prod
            branch: main
            tf_dir: infra/environment/prod
          - name: dev
            branch: dev
            tf_dir: infra/environment/dev

    env:
      AWS_REGION: us-east-1
      ENV: ${{ matrix.env.name }}
      TF_DIR: ${{ matrix.env.tf_dir }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.env.branch }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -input=false

      - name: Terraform Validate
        working-directory: ${{ env.TF_DIR }}
        run: terraform validate

      #  Drift detection (captures exit code correctly)
      - name: Terraform Drift Check
        id: plan
        working-directory: ${{ env.TF_DIR }}
        continue-on-error: true
        run: |
          terraform plan -detailed-exitcode -no-color
          echo "exitcode=$?" >> $GITHUB_OUTPUT

      # Generate drift report
      - name: Generate Drift Report
        if: steps.plan.outputs.exitcode == '2'
        working-directory: ${{ env.TF_DIR }}
        run: |
          terraform plan -out=tfplan -no-color
          terraform show tfplan > drift.txt

      #  Upload artifact
      - name: Upload Drift Artifact
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-drift-report-${{ env.ENV }}
          path: ${{ env.TF_DIR }}/drift.txt
          retention-days: 2

      #  Email alert
      - name: Send Email Alert (Drift Detected)
        if: steps.plan.outputs.exitcode == '2'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® Terraform Drift Detected (${{ env.ENV }}) ‚Äì ${{ github.repository }}"
          to: sshivam03sharma@gmail.com
          from: Terraform CI <${{ secrets.SMTP_USERNAME }}>
          body: |
            üö® TERRAFORM DRIFT DETECTED

            Environment: ${{ env.ENV }}
            Branch: ${{ matrix.env.branch }}

            Terraform detected infrastructure drift.

            Run URL:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      # ‚ùå Fail job if drift exists
      - name: Fail Pipeline if Drift Found
        if: steps.plan.outputs.exitcode == '2'
        run: |
          echo "‚ùå Terraform Drift Detected ‚Äî failing pipeline"
          exit 1
