name: Terraform Drift Detection

on:
  # schedule:
    # - cron: "0 14 * * *"  
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  drift-detection:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        env:
          - name: prod
            branch: main
            tf_dir: infra/environment/prod
          - name: dev
            branch: dev
            tf_dir: infra/environment/dev

    env:
      AWS_REGION: us-east-1
      ENV: ${{ matrix.env.name }}
      TF_DIR: ${{ matrix.env.tf_dir }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ matrix.env.branch }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -input=false

      # ðŸ”¥ FIXED DRIFT DETECTION
      - name: Terraform Drift Check
        id: plan
        working-directory: ${{ env.TF_DIR }}
        shell: bash
        run: |
          set +e
          terraform plan -detailed-exitcode -no-color -input=false \
            > plan_output.txt 2>&1
          EXIT_CODE=$?
          set -e

          echo "exitcode=$EXIT_CODE" >> $GITHUB_OUTPUT

          if [ "$EXIT_CODE" -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Drift Report
        if: steps.plan.outputs.drift_detected == 'true'
        working-directory: ${{ env.TF_DIR }}
        run: |
          terraform show -no-color tfplan || true
          cat plan_output.txt > drift.txt

      - name: Upload Drift Artifact
        if: steps.plan.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-drift-${{ env.ENV }}
          path: ${{ env.TF_DIR }}/drift.txt
          retention-days: 2

      - name: Send Email Alert
        if: steps.plan.outputs.drift_detected == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸš¨ Terraform Drift Detected (${{ env.ENV }})"
          to: sshivam03sharma@gmail.com
          from: Terraform CI <${{ secrets.SMTP_USERNAME }}>
          body: |
            Terraform drift detected.

            Environment: ${{ env.ENV }}
            Branch: ${{ matrix.env.branch }}

            Run:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Fail Job on Drift
        if: steps.plan.outputs.drift_detected == 'true'
        run: exit 1
