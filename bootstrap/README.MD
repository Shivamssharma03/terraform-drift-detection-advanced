# Terraform Bootstrap â€“ Secure Backend & GitHub Actions OIDC

This repository contains a **productionâ€‘grade Terraform bootstrap setup** that creates:

* Secure **S3 remote backend** for Terraform state
* **DynamoDB** table for state locking
* **KMSâ€‘encrypted** Terraform state (SSEâ€‘KMS)
* **GitHub Actions OIDC** integration (no static AWS keys)
* Leastâ€‘privilege IAM design

This bootstrap layer is intended to be run **once per AWS account**, and then reused by all other Terraform stacks.

---

## ðŸ” Architecture Overview

```text
GitHub Actions
   â”‚ (OIDC token)
   â–¼
IAM Role (OIDCâ€‘assumable)
   â”‚
   â”œâ”€â”€ S3 access (state)
   â”œâ”€â”€ DynamoDB access (locking)
   â””â”€â”€ KMS decrypt permissions

S3 Bucket (Terraform State)
   â””â”€â”€ Encrypted with KMS (SSEâ€‘KMS)
```

**Key idea:**

* OIDC answers **WHO you are**
* IAM role answers **WHAT you can do**
* KMS answers **WHO can read the Terraform state**

---

## ðŸ“ Repository Structure

```text
bootstrap/
â”œâ”€â”€ main.tf                # Root module wiring
â”œâ”€â”€ variables.tf           # Root variable declarations
â”œâ”€â”€ outputs.tf             # Root outputs
â”œâ”€â”€ terraform.tfvars       # Input values (not committed)
â””â”€â”€ modules/
    â”œâ”€â”€ oidc/               # GitHub Actions OIDC + IAM role
    â”‚   â”œâ”€â”€ main.tf
    â”‚   â”œâ”€â”€ variables.tf
    â”‚   â””â”€â”€ outputs.tf
    â”‚
    â””â”€â”€ backend/            # Terraform backend resources
        â”œâ”€â”€ s3.tf +
        â”œâ”€â”€ dynamodb.tf
        â”œâ”€â”€ kms.tf
        â”œâ”€â”€ kms_policy.tf
        â”œâ”€â”€ s3_encryption.tf
        â”œâ”€â”€ variables.tf
        â””â”€â”€ outputs.tf
```

---

## ðŸš€ What This Bootstrap Creates

### 1ï¸âƒ£ GitHub Actions OIDC

* AWS IAM OIDC identity provider
* IAM role assumable by GitHub Actions
* Repo + branchâ€‘level trust policy
* No AWS access keys required

### 2ï¸âƒ£ Terraform Backend (Secure by Default)

* S3 bucket for Terraform state
* DynamoDB table for state locking
* KMS encryption (SSEâ€‘KMS)
* Versioning enabled
* Public access blocked
* HTTPS enforced

### 3ï¸âƒ£ KMS Security Model

* Customerâ€‘managed KMS key
* Key rotation enabled
* **ONLY the OIDC IAM role can decrypt Terraform state**
* Root account retained for breakâ€‘glass recovery

---

## ðŸ”‘ Security Guarantees

| Scenario          | Result                            |
| ----------------- | --------------------------------- |
| S3 bucket leaked  | State unreadable (KMS encrypted)  |
| IAM admin access  | Still blocked without KMS decrypt |
| Local user access | Denied                            |
| Only CI/CD role   | Allowed                           |

> **KMS decrypt permission is the final gatekeeper.**

---

## ðŸ§© Module Details

### OIDC Module (`modules/oidc`)

Creates:

* `aws_iam_openid_connect_provider`
* `aws_iam_role` with trust policy

Output:

```hcl
output "role_arn" {
  value = aws_iam_role.github_actions.arn
}
```

This ARN is passed to the backend module to control access.

---

### Backend Module (`modules/backend`)

Creates:

* S3 bucket for state
* DynamoDB lock table
* KMS key + alias
* KMS key policy (decrypt restricted)
* S3 SSEâ€‘KMS enforcement

Key variable:

```hcl
variable "terraform_role_arn" {
  description = "IAM role allowed to decrypt Terraform state"
  type        = string
}
```

---

## ðŸ” KMS Policy Logic (Important)

```text
KMS key
 â”œâ”€â”€ Root account â†’ breakâ€‘glass access
 â””â”€â”€ GitHub OIDC role â†’ encrypt/decrypt Terraform state
```

KMS **does not care about file paths**.
If an object is encrypted with this key, only allowed principals can read it.

---

## ðŸ§ª How to Use This Bootstrap

### 1ï¸âƒ£ Configure variables

Create `terraform.tfvars`:

```hcl
bucket_name = "my-terraform-remote-state"
lock_table  = "terraform-locks"
role_name   = "github-actions-oidc-role"

repo_subs = [
  "repo:ORG/REPO:ref:refs/heads/*"
]
```

---

### 2ï¸âƒ£ Initialize and apply bootstrap

```bash
terraform init
terraform apply
```

Run this **once** per AWS account.

---

### 3ï¸âƒ£ Use the backend in other stacks

```hcl
terraform {
  backend "s3" {
    bucket         = "my-terraform-remote-state"
    key            = "infra/terraform.tfstate"
    region         = "us-east-1"
    dynamodb_table = "terraform-locks"
    encrypt        = true
    kms_key_id     = "alias/terraform-backend"
  }
}
```

---

## ðŸ” Handling Manual Changes (Drift)

If a resource is created or modified manually:

1. Define the resource in Terraform
2. Import it:

```bash
terraform import aws_resource.example RESOURCE_ID
```

Only identities that can **decrypt the state** can perform imports.

---

## âŒ What This Bootstrap Intentionally Avoids

* âŒ No static AWS credentials
* âŒ No secrets in Terraform state
* âŒ No public S3 access
* âŒ No human access to state

---

## ðŸ›¡ï¸ Best Practices Followed

* Defense in depth (IAM + S3 + KMS)
* Least privilege
* OIDCâ€‘based authentication
* Encrypted state at rest and in transit
* Versioned state with locking

---

## ðŸ“Œ Important Notes

* This bootstrap **must exist before** other Terraform stacks
* Do not delete the backend bucket or KMS key
* Protect the AWS root account with MFA

---

## âœ… Summary

This bootstrap provides a **secure, scalable, and auditâ€‘friendly Terraform foundation** suitable for production environments.

> **Control KMS decrypt permissions â†’ control Terraform state access**

---


